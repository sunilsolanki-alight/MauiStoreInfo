name: CI - Build and Test

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_MAUI_VERSION: '8.0.x'
  CONFIGURATION: 'Release'

permissions:
  contents: read

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Build StoreInfoMaui (Android)
        run: dotnet build src/StoreInfoMaui/StoreInfoMaui.csproj -c ${{ env.CONFIGURATION }} -f net7.0-android --no-restore

      - name: Upload Android build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            src/StoreInfoMaui/bin/${{ env.CONFIGURATION }}/net7.0-android/
          retention-days: 7

  build-ios:
    name: Build iOS
    runs-on: macos-13
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Build StoreInfoMaui (iOS)
        run: dotnet build src/StoreInfoMaui/StoreInfoMaui.csproj -c ${{ env.CONFIGURATION }} -f net7.0-ios --no-restore

      - name: Upload iOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            src/StoreInfoMaui/bin/${{ env.CONFIGURATION }}/net7.0-ios/
          retention-days: 7

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Build StoreInfoMaui (Windows)
        run: dotnet build src/StoreInfoMaui/StoreInfoMaui.csproj -c ${{ env.CONFIGURATION }} -f net7.0-windows10.0.19041.0 --no-restore

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            src/StoreInfoMaui/bin/${{ env.CONFIGURATION }}/net7.0-windows10.0.19041.0/
          retention-days: 7

  build-xamarin:
    name: Build Xamarin Plugin
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore src/StoreInfoPlugin.sln

      - name: Build Xamarin Plugin
        run: msbuild src/StoreInfo/StoreInfo.csproj /p:Configuration=${{ env.CONFIGURATION }} /p:Platform=AnyCPU

      - name: Upload Xamarin build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xamarin-build
          path: |
            src/StoreInfo/bin/${{ env.CONFIGURATION }}/
          retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Format check
        run: dotnet format src/StoreInfoPlugin.sln --verify-no-changes --verbosity diagnostic || true

      - name: Build solution
        run: dotnet build src/StoreInfoPlugin.sln -c ${{ env.CONFIGURATION }} --no-restore

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-windows, build-xamarin, code-quality]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          echo "Build Summary:"
          echo "- Android Build: ${{ needs.build-android.result }}"
          echo "- iOS Build: ${{ needs.build-ios.result }}"
          echo "- Windows Build: ${{ needs.build-windows.result }}"
          echo "- Xamarin Build: ${{ needs.build-xamarin.result }}"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          
          if [ "${{ needs.build-android.result }}" != "success" ] || \
             [ "${{ needs.build-ios.result }}" != "success" ] || \
             [ "${{ needs.build-windows.result }}" != "success" ] || \
             [ "${{ needs.build-xamarin.result }}" != "success" ]; then
            echo "One or more builds failed!"
            exit 1
          fi
