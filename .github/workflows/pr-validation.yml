name: PR Validation

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'

permissions:
  contents: read

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: PR Details
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Base: ${{ github.event.pull_request.base.ref }}"
          echo "Head: ${{ github.event.pull_request.head.ref }}"

  validate-files:
    name: Validate File Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            src/**/*.cs
            src/**/*.csproj
            **/*.yml
            **/*.yaml

      - name: List changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

  quick-build:
    name: Quick Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Build solution (quick check)
        run: dotnet build src/StoreInfoPlugin.sln -c Debug --no-restore

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore src/StoreInfoPlugin.sln

      - name: Run code analysis
        run: dotnet build src/StoreInfoPlugin.sln -c ${{ env.CONFIGURATION }} /p:TreatWarningsAsErrors=false

  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-info, validate-files, quick-build, code-analysis]
    if: always()
    
    steps:
      - name: Validation Summary
        run: |
          echo "PR Validation Results:"
          echo "- File Validation: ${{ needs.validate-files.result }}"
          echo "- Quick Build: ${{ needs.quick-build.result }}"
          echo "- Code Analysis: ${{ needs.code-analysis.result }}"
          
          if [ "${{ needs.quick-build.result }}" != "success" ] || \
             [ "${{ needs.code-analysis.result }}" != "success" ]; then
            echo "PR validation failed!"
            exit 1
          fi
          
          echo "âœ… PR validation passed!"
